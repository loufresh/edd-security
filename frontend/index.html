
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDD Security — Console</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { --bg:#0b1320; --card:#0f1a33; --line:#1f2e4d; --brand:#ff6a00; --brand2:#2d6cff; --text:#eaf0ff; --muted:#b7c3e0; }
    * { box-sizing: border-box; }
    body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif; margin:0; }
    header { padding: 18px 24px; border-bottom: 1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand { display:flex; align-items:center; gap:12px; }
    .badge { background:var(--brand); color:var(--bg); padding:6px 10px; border-radius:8px; font-weight:800; }
    nav a { color:var(--muted); text-decoration:none; margin-right:14px; font-weight:600; }
    nav a.active { color:var(--text); border-bottom:2px solid var(--brand); padding-bottom:4px; }
    main { padding:24px; display:grid; gap:16px; grid-template-columns: 260px 1fr; }
    .panel { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; }
    h1 { font-size:20px; margin:0; letter-spacing:.5px; }
    h2 { font-size:16px; margin:8px 0 8px 0; color:#9fb3ff }
    p { margin:8px 0 0 0; color:var(--muted) }
    input, button, select, textarea { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e1630; color:var(--text); width:100%; }
    label { font-size:12px; color:#9fb3ff; display:block; margin-top:8px; margin-bottom:6px; }
    .row { display:flex; gap:10px; align-items:stretch; }
    .btn { background:var(--brand2); color:white; font-weight:800; cursor:pointer; border:0; }
    .btn-outline { background:transparent; border:1px solid var(--brand2); color:var(--brand2); }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:14px; color:var(--muted); }
    th { color:#9fb3ff }
    .pill { background:#0e2740; padding:4px 8px; border-radius:999px; font-size:12px; color:#9fb3ff; display:inline-block;}
    .muted { color:var(--muted); font-size:12px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="badge">EDD</span>
      <h1>EDD Security — Console</h1>
    </div>
    <nav>
      <a href="#onboarding" id="tab-onboarding">Onboarding</a>
      <a href="#jobs" id="tab-jobs">Jobs</a>
      <a href="#runs" id="tab-runs">Runs</a>
      <a href="#alerts" id="tab-alerts">Alertas</a>
      <a href="#notify" id="tab-notify">Notificaciones</a>
      <a href="#keys" id="tab-keys">API Keys</a>
    </nav>
  </header>
  <main>
    <aside class="panel" id="sidebar">
      <h2>Cuenta</h2>
      <div class="stack">
        <label>Empresa</label>
        <input id="company" placeholder="EDD Demo Co."/>
        <label>Email</label>
        <input id="email" placeholder="admin@example.com"/>
        <label>Password</label>
        <input id="password" type="password" placeholder="•••••••"/>
        <div class="row">
          <button class="btn" id="btn-org">Org Signup</button>
          <button class="btn btn-outline" id="btn-login">Login</button>
        </div>
        <p class="muted" id="auth-status">Sin token</p>
        <p class="muted" id="tenant-status">Sin tenant</p>
      </div>

      <h2>Proyecto</h2>
      <div class="stack">
        <label>Project ID</label>
        <input id="project-id" placeholder="1"/>
      </div>

      <h2>Acciones rápidas</h2>
      <div class="stack">
        <button class="btn" id="btn-load-jobs">Cargar Jobs</button>
        <button class="btn" id="btn-load-runs">Cargar Runs</button>
        <button class="btn" id="btn-load-alerts">Cargar Alertas</button>
      </div>
    </aside>

    <section class="panel" id="content">
      <!-- SPA content -->
    </section>
  </main>

  <script type="text/javascript">
    const $ = (sel) => document.querySelector(sel);
    const API = (p, opts={}) => fetch(`http://localhost:8000${p}`, opts);

    let STATE = { token: "", tenant_id: null, project_id: null, api_key: null, tab: "onboarding" };

    function setStatus() {
      $("#auth-status").textContent = STATE.token ? "Token listo" : "Sin token";
      $("#tenant-status").textContent = STATE.tenant_id ? ("Tenant " + STATE.tenant_id) : "Sin tenant";
      $("#project-id").value = STATE.project_id || "";
      document.querySelectorAll('nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#'+STATE.tab));
    }

    function mount() {
      // events
      $("#btn-org").onclick = async () => {
        const body = {
          company_name: $("#company").value || "EDD Demo Co.",
          email: $("#email").value,
          password: $("#password").value
        };
        const r = await API('/auth/org-signup', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const j = await r.json();
        STATE.token = j.access_token; STATE.tenant_id = j.tenant_id; STATE.project_id = j.project_id; STATE.api_key = j.api_key;
        alert('API Key (tenant): ' + (STATE.api_key || '')); setStatus(); route();
        startSSE();
      };
      $("#btn-login").onclick = async () => {
        const body = { email: $("#email").value, password: $("#password").value };
        const r = await API('/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const j = await r.json(); STATE.token = j.access_token; STATE.tenant_id = j.tenant_id; setStatus(); route(); startSSE();
      };
      $("#btn-load-jobs").onclick = loadJobs;
      $("#btn-load-runs").onclick = loadRuns;
      $("#btn-load-alerts").onclick = loadAlerts;

      // tabs
      document.querySelectorAll('nav a').forEach(a => {
        a.addEventListener('click', (ev) => { ev.preventDefault(); STATE.tab = a.getAttribute('href').slice(1); route(); });
      });

      window.addEventListener('hashchange', () => { STATE.tab = location.hash.slice(1) || 'onboarding'; route(); });
      STATE.tab = location.hash.slice(1) || 'onboarding';
      setStatus(); route();
    }

    function authHeaders() {
      return STATE.token ? { Authorization: 'Bearer ' + STATE.token } : {};
    }

    async function loadJobs() {
      const pid = $("#project-id").value || "";
      const qs = pid ? ('?project_id='+pid) : '';
      const r = await API('/jobs/' + qs, { headers: { ...authHeaders() } });
      const j = await r.json();
      renderJobs(j.jobs || []);
    }

    async function loadRuns() {
      const pid = $("#project-id").value || "";
      const qs = pid ? ('?project_id='+pid) : '';
      const r = await API('/runs/' + qs, { headers: { ...authHeaders() } });
      const j = await r.json();
      renderRuns(j.runs || []);
    }

    async function loadAlerts() {
      const pid = $("#project-id").value || "";
      const qs = pid ? ('?project_id='+pid) : '';
      const r = await API('/alerts/' + qs, { headers: { ...authHeaders() } });
      const j = await r.json();
      renderAlerts(j.alerts || []);
    }

    function startSSE() {
      const es = new EventSource('http://localhost:8000/events/stream');
      es.onmessage = (ev) => {
        try { const data = JSON.parse(ev.data); if(Array.isArray(data)) { const node = $("#alerts-live"); if (node) { prependLiveAlerts(node, data); } } } catch {}
      };
    }

    function prependLiveAlerts(node, arr) {
      arr.forEach(a => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="pill">${(a.severity||'').toUpperCase()}</span> ${a.message}`;
        node.prepend(li);
      });
    }

    function route() {
      const tab = STATE.tab;
      if (tab === 'onboarding') return renderOnboarding();
      if (tab === 'jobs') return loadJobs();
      if (tab === 'runs') return loadRuns();
      if (tab === 'alerts') return loadAlerts();
      if (tab === 'notify') return renderNotify();
      if (tab === 'keys') return renderKeys();
      renderOnboarding();
    }

    function renderOnboarding() {
      $("#content").innerHTML = `
        <h2>Onboarding</h2>
        <p>1) Crea tu organización (tenant) o inicia sesión. 2) Define <b>Project ID</b>. 3) Carga <b>Jobs</b>, ejecuta y mira <b>Runs</b> y <b>Alertas</b> en tiempo real.</p>
        <div class="panel" style="margin-top:12px;">
          <h3>Crear Job de ejemplo</h3>
          <div class="row">
            <div style="flex:1;">
              <label>Task</label>
              <select id="task-name">
                <option value="automation.scrape_prices">automation.scrape_prices</option>
                <option value="automation.build_report">automation.build_report</option>
                <option value="security.monitor_logs">security.monitor_logs</option>
              </select>
            </div>
            <div style="width:220px;">
              <label>Project ID</label>
              <input id="task-project" placeholder="1"/>
            </div>
          </div>
          <label>Params (JSON)</label>
          <textarea id="task-params" rows="6">{ "urls": ["https://example.com"], "selector": "title", "delay": 1 }</textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btn-create-job">Crear Job</button>
            <button class="btn btn-outline" id="btn-run-now">Run Now</button>
          </div>
          <p class="muted" id="task-result"></p>
        </div>
      `;
      $("#btn-create-job").onclick = async () => {
        const body = {
          type: $("#task-name").value,
          project_id: parseInt($("#task-project").value || "0") || null,
          params: JSON.parse($("#task-params").value || "{}")
        };
        const r = await API('/jobs/', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify(body)});
        const j = await r.json(); $("#task-result").textContent = JSON.stringify(j);
      };
      $("#btn-run-now").onclick = async () => {
        const body = {
          task_name: $("#task-name").value,
          project_id: parseInt($("#task-project").value || "0") || null,
          params: JSON.parse($("#task-params").value || "{}")
        };
        const r = await API('/jobs/run-now', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify(body)});
        const j = await r.json(); $("#task-result").textContent = JSON.stringify(j);
      };
    }

    function renderJobs(rows) {
      $("#content").innerHTML = `
        <h2>Jobs</h2>
        <table>
          <thead><tr><th>ID</th><th>Project</th><th>Type</th><th>Params</th><th>Actions</th></tr></thead>
          <tbody id="jobs-body"></tbody>
        </table>
      `;
      const tb = $("#jobs-body");
      rows.forEach(j => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${j.id}</td>
          <td>\${j.project_id ?? '-'}</td>
          <td><code>\${j.type}</code></td>
          <td><code>\${JSON.stringify(j.params || {})}</code></td>
          <td><button class="btn btn-outline" data-task="\${j.type}" data-jid="\${j.id}" data-pid="\${j.project_id ?? ''}">Run</button></td>
        \`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button').forEach(btn => {
        btn.onclick = async () => {
          const body = { task_name: btn.dataset.task, job_id: parseInt(btn.dataset.jid), project_id: btn.dataset.pid ? parseInt(btn.dataset.pid) : null, params: {} };
          const r = await API('/jobs/run-now', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeaders() }, body: JSON.stringify(body)});
          const j = await r.json(); alert('Enqueued: ' + JSON.stringify(j));
        };
      });
    }

    function renderRuns(rows) {
      $("#content").innerHTML = `
        <h2>Runs</h2>
        <table>
          <thead><tr><th>ID</th><th>Task</th><th>Status</th><th>Project</th><th>Started</th><th>Finished</th><th>Output</th></tr></thead>
          <tbody id="runs-body"></tbody>
        </table>
      `;
      const tb = $("#runs-body");
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td><code>\${r.id}</code></td>
          <td><code>\${r.task_name}</code></td>
          <td>\${badge(r.status)}</td>
          <td>\${r.project_id ?? '-'}</td>
          <td>\${r.created_at ?? '-'}</td>
          <td>\${r.finished_at ?? '-'}</td>
          <td><details><summary>ver</summary><pre style="white-space:pre-wrap">\${JSON.stringify(r.output || r.error_text || {}, null, 2)}</pre></details></td>
        \`;
        tb.appendChild(tr);
      });
    }

    function badge(s) { return '<span class="pill">'+String(s || '').toUpperCase()+'</span>'; }

    function renderAlerts(rows) {
      $("#content").innerHTML = `
        <h2>Alertas</h2>
        <ul id="alerts-live"></ul>
        <h3>Historial</h3>
        <table>
          <thead><tr><th>ID</th><th>Severity</th><th>Mensaje</th><th>Proyecto</th><th>Fecha</th></tr></thead>
          <tbody id="alerts-body"></tbody>
        </table>
      `;
      const tb = $("#alerts-body");
      rows.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${a.id}</td>
          <td>\${badge(a.severity)}</td>
          <td>\${a.message}</td>
          <td>\${a.project_id ?? '-'}</td>
          <td>\${a.created_at ?? '-'}</td>
        \`;
        tb.appendChild(tr);
      });
    }

    function renderNotify() {
      $("#content").innerHTML = `
        <h2>Notificaciones</h2>
        <p>Envía una alerta de prueba que se notificará por Slack/Telegram/WhatsApp/Email según configuración.</p>
        <label>Mensaje</label>
        <input id="notify-msg" value="Alerta de prueba desde EDD Console"/>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btn-send">Enviar</button>
        </div>
        <p class="muted" id="notify-res"></p>
      `;
      $("#btn-send").onclick = async () => {
        const body = { severity: "info", message: $("#notify-msg").value, metadata: { from:"console" } };
        // Use webhook ingest with tenant header (demo)
        const r = await API('/webhooks/ingest', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-tenant-id': String(STATE.tenant_id || 1) }, body: JSON.stringify(body)});
        const j = await r.json(); $("#notify-res").textContent = JSON.stringify(j);
      };
    }

    function renderKeys() {
      $("#content").innerHTML = `
        <h2>API Keys</h2>
        <p class="muted">Tu API Key se mostró al crear la organización. Usa el header <code>X-API-Key</code> con <code>/jobs/run-now</code>.</p>
        <p><b>API Key actual:</b> <code>${(STATE.api_key || '—')}</code></p>
      `;
    }

    mount();
  </script>
</body>
</html>
